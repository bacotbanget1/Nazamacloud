<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keranjang - Nazamacloud</title>
    <link rel="icon" href="https://i.imgur.com/iyWLyWw.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); color: #1e293b; padding: 20px; }
        .card { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .cart-item { border-bottom: 1px solid #eee; padding: 15px 0; position: relative; }
        .old-price { text-decoration: line-through; color: #94a3b8; margin-right: 8px; }
        .detail-input { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f1f5f9; }
        .btn-wa { background: #25d366; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .coupon-section { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ðŸ›’ Keranjang Belanja</h2>
    <div id="cart-list"></div>

    <div class="coupon-section">
        <p>Gunakan Kupon:</p>
        <div style="display:flex; gap:10px;">
            <input type="text" id="coupon-input" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="KODE KUPON">
            <button id="apply-btn" style="padding:10px; background:var(--primary); color:white; border:none; border-radius:8px;">Pakai</button>
        </div>
        <p id="coupon-msg" style="margin-top:5px; font-size:0.8rem;"></p>
    </div>

    <div id="total-area" style="font-size: 1.4rem; font-weight: bold; margin-top: 20px;">Total: Rp 0</div>
    <button class="btn-wa" onclick="checkoutWA()"><i class="fab fa-whatsapp"></i> Checkout via WhatsApp</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { /* SAMA DENGAN DI ATAS */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let cart = JSON.parse(localStorage.getItem('nazama_cart')) || [];
    let discount = 0;
    let activeCode = "";

    function render() {
        const list = document.getElementById('cart-list');
        let subtotal = 0;
        list.innerHTML = cart.length ? "" : "Keranjang kosong.";

        cart.forEach((item, i) => {
            subtotal += item.harga;
            let hint = item.type === 'Panel MC' ? "Username & Nama Server" : "Detail Pesanan (Contoh: nama.com)";
            list.innerHTML += `
                <div class="cart-item">
                    <b>${item.nama}</b> (${item.type}) <br>
                    <span style="color:var(--primary); font-weight:bold;">Rp ${item.harga.toLocaleString()}</span>
                    <input type="text" class="detail-input" placeholder="${hint}" onchange="saveDetail(${i}, this.value)" value="${item.detail||''}">
                </div>`;
        });

        const totalArea = document.getElementById('total-area');
        if(discount > 0) {
            let final = subtotal - (subtotal * discount / 100);
            totalArea.innerHTML = `Total: <span class="old-price">~Rp ${subtotal.toLocaleString()}~</span> <span style="color:#10b981">Rp ${final.toLocaleString()}</span>`;
        } else {
            totalArea.innerHTML = `Total: Rp ${subtotal.toLocaleString()}`;
        }
    }

    window.saveDetail = (i, val) => { cart[i].detail = val; localStorage.setItem('nazama_cart', JSON.stringify(cart)); };

    document.getElementById('apply-btn').onclick = async () => {
        const code = document.getElementById('coupon-input').value.toUpperCase();
        const snap = await get(ref(db, 'coupons/' + code));
        if(snap.exists()) {
            discount = snap.val().percent;
            activeCode = code;
            document.getElementById('coupon-msg').innerText = `Diskon ${discount}% Berhasil!`;
            document.getElementById('coupon-msg').style.color = "green";
            render();
        } else { alert("Kupon tidak ditemukan di database!"); }
    };

    window.checkoutWA = () => {
        let text = "*ORDER NAZAMACLOUD*\n\n";
        cart.forEach(item => { text += `- ${item.nama}: ${item.detail || '-'}\n`; });
        text += `\n*Kupon:* ${activeCode || '-'}\n*Total:* ${document.getElementById('total-area').innerText}`;
        window.open(`https://wa.me/6283142474788?text=${encodeURIComponent(text)}`);
    };

    render();
</script>
</body>
</html>
